{% include 'base.html' %}
{% include 'navbar.html' %}

<div class="rounded-2xl container ml-20 border border-gray-200 bg-white p-6 shadow-sm">
  <h4 class="text-sm font-medium text-gray-700">World map (latest year)</h4>
  <canvas id="world-map" class="mt-3 h-96 w-full"></canvas>
  <p id="hover-info" class="mt-2 text-sm text-gray-600">Hover a country</p>
</div>

<script>
async function renderWorldMap(){
  const topo = await fetch("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json")
    .then(r => r.json());

  const countries = ChartGeo.topojson.feature(topo, topo.objects.countries).features;

  const { year, results } = await loadRates()
  const valueByName = Object.fromEntries(
    results.map(r => [String(r.country || "").toLowerCase(), Number(r.value)])
  )

   const iso3ByName = Object.fromEntries(
     results.map(r => [String(r.country || "").toLowerCase(), String(r.iso3_code || "").toUpperCase()])
    )

  const data = countries.map(f => {
    const nameLc = String(f.properties?.name || "").toLowerCase()
    const v = valueByName[nameLc];
    return { feature: f, value: Number.isFinite(v) ? v : null }
  })

  const ctx = document.getElementById("world-map")
  new Chart(ctx, {
    type: "choropleth",
    data: {
      labels: countries.map(f => f.properties?.name || "Unknown"),
      datasets: [{ label: `Rate per 100k (${year})`, data }]
    },
    options: {
      showOutline: true,
      showGraticule: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (c) => {
              const n = c.raw.feature.properties?.name || "Unknown"
              const v = c.raw.value;
              return `${n}: ${v == null ? "N/A" : v.toFixed(2)}`
            }
          }
        }
      },
      scales: {
        projection: { axis: "x", projection: "equalEarth" },
        color: { axis: "y", quantize: 7, legend: { position: "bottom" } }
      },
      onHover(evt, active, chart) {
        chart.canvas.style.cursor = active.length ? "pointer" : "default"
        const info = document.getElementById("hover-info")
        if (!info) return
        if (active.length) {
          const d = chart.data.datasets[0].data[active[0].index]
          const n = d.feature.properties?.name || "Unknown"
          info.textContent = `${n} â€” ${d.value == null ? "N/A" : d.value.toFixed(2)}`
        } else {
          info.textContent = "Hover a country"
        }
      },
      async onClick(evt, active, chart) {
        if (!active.length) return
        const d = chart.data.datasets[0].data[active[0].index]
        const clickedName = d.feature.properties?.name || ""
        console.log("Clicked:", clickedName)
      }
    }
  })
}

renderWorldMap().catch(console.error)
</script>