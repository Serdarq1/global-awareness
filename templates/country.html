<section id="country" class="mx-auto mt-10 w-full max-w-7xl px-4 sm:px-6 lg:px-8">
  <div class="grid grid-cols-1 gap-6 sm:gap-8 lg:grid-cols-3">
    <article class="rounded-2xl border border-gray-200 bg-white p-4 sm:p-6 shadow-sm">
      <h3 class="text-base sm:text-lg font-semibold text-gray-900" id="country-name">Select a country</h3>
      <p class="mt-1 text-sm text-gray-600" id="country-sub">Select a country to view trends.</p>

      <label for="country-select" class="sr-only">Country</label>
      <select id="country-select"
        class="mt-3 w-full rounded-md border border-gray-200 bg-white p-2 text-base sm:text-sm text-gray-900">
        <option selected disabled>Select a country</option>
      </select>

      <dl class="mt-5 grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4 text-sm">
        <div class="rounded-xl bg-gray-50 p-3 shadow-sm">
          <dt class="text-gray-600">Latest rate / 100k</dt>
          <dd class="mt-1 font-semibold text-gray-900" id="c-latest-rate">—</dd>
        </div>
        <div class="rounded-xl bg-gray-50 p-3 shadow-sm">
          <dt class="text-gray-600">Latest count</dt>
          <dd class="mt-1 font-semibold text-gray-900" id="c-latest-count">—</dd>
        </div>
        <div class="rounded-xl bg-gray-50 p-3 shadow-sm">
          <dt class="text-gray-600">Trend (5y)</dt>
          <dd class="mt-1 font-semibold text-gray-900" id="c-trend">—</dd>
        </div>
        <div class="rounded-xl bg-gray-50 p-3 shadow-sm">
          <dt class="text-gray-600">Region avg</dt>
          <dd class="mt-1 font-semibold text-gray-900" id="c-region-avg">—</dd>
        </div>
      </dl>
    </article>

    <div class="lg:col-span-2 space-y-6">
      <div class="rounded-2xl border border-gray-200 bg-white p-4 sm:p-6 shadow-sm">
        <h4 class="text-sm font-medium text-gray-700">Rate over time</h4>
        <div class="relative mt-3 h-60 sm:h-72 md:h-80 lg:h-96">
          <canvas id="line-rate" class="absolute inset-0 w-full h-full block text-gray-500"></canvas>
        </div>
      </div>

      <div class="rounded-2xl border border-gray-200 bg-white p-4 sm:p-6 shadow-sm">
        <h4 class="text-sm font-medium text-gray-700">Region comparison</h4>
        <div class="relative mt-3 h-56 sm:h-64 md:h-72 lg:h-80">
          <canvas id="bar-rate" class="absolute inset-0 w-full h-full block text-gray-500"></canvas>
        </div>
      </div>
    </div>
  </div>
</section>


<script>
  const ctx = document.getElementById('line-rate')
  const bar = document.getElementById('bar-rate')

  let rateChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: [],
      datasets: [{
        label: '# Violence Rate Over Time',
        data: [],
        borderWidth: 1
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  })

  let barChart = new Chart(bar, {
    type: "bar",
    data: {
      labels: [],
      datasets: [{
        label: '# Region Comparison',
        data: [],
        borderWidth: 1
      }]
    },
     options: {
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  })

  function renderCountries(countries, selectEl){
    selectEl.innerHTML = '<option selected disabled>Select a country</option>'

    countries.forEach((r)=> {
      const option = document.createElement('option')
      option.className = "w-full text-sm" 
      option.innerHTML = `${r.country}`
      option.value = r.iso3_code
      selectEl.appendChild(option)
    })

    
  }

  async function loadCountry(iso3) {
    const res = await fetch(`${API_BASE}/country/${iso3}`)
    if (!res.ok) throw new Error('Failed to load the country.')
    return await res.json()
  }

  (async function init() {
    const selectEl = document.getElementById('country-select');
    const latestRate = document.getElementById('c-latest-rate');
    const latestCount = document.getElementById('c-latest-count');
    const latestTrend = document.getElementById('c-trend');
    const regionAvg = document.getElementById('c-region-avg');
    const titleEl = document.getElementById('country-name');
    const subEl = document.getElementById('country-sub');

    try {
      let { results } = await loadRates();
      renderCountries(results, selectEl);
    } catch (e) {
      console.error("Failed to fetch data.", e)
    }

    selectEl.addEventListener("change", async () => {
  try {
    const data = await loadCountry(selectEl.value)
    const series = Array.isArray(data.series) ? data.series.slice().sort((a,b)=>a.year-b.year) : []
    const latest  = series[series.length - 1] || {}
    const labels  = series.map(s => String(s.year))
    const values  = series.map(s => Number(s.rate_per_100k) || null)
    const regionAvgVal = Number(data.region_avg_latest)

    rateChart.data.labels = labels
    rateChart.data.datasets[0].data = values
    rateChart.update()

    const latestRateNum = Number(latest.rate_per_100k)
    barChart.data.labels = [data.country ?? "Country", data.region ?? "Region"]
    barChart.data.datasets[0].data = [
      isFinite(latestRateNum) ? latestRateNum : 0,
      isFinite(regionAvgVal)  ? regionAvgVal  : 0
    ]
    barChart.update()

    titleEl.textContent = data.country || "Selected country"
    subEl.textContent   = latest?.year ? `Latest year: ${latest.year}` : "No recent year available"

    const countVal = latest.count
    latestRate.textContent  = isFinite(latestRateNum) ? latestRateNum.toFixed(2) : "—"
    latestCount.textContent = (countVal ?? "") !== "" ? String(countVal) : "—"
    latestTrend.textContent = series.length >= 2 ? "See Chart" : "N/A"
    regionAvg.textContent   = isFinite(regionAvgVal) ? regionAvgVal.toFixed(2) : "N/A"

  } catch (e) {
    console.error(e)
    latestRate.textContent  = "—"
    latestCount.textContent = "—"
    latestTrend.textContent = "—"
    regionAvg.textContent   = "—"
  }
})
  })()

</script>